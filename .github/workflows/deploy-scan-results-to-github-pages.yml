name: deploy-scan-results-to-github-pages
on:
  push:
    branches:
      - main
permissions:
  contents: write
jobs:
  build-and-deploy:
    concurrency: ci-${{ github.ref }} # Recommended if you intend to make multiple deployments in quick succession.
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3
        with:
          path: main

      - name: Creating scan results
        run: |
          reportName='main/scan-results/result.json'
           cat 
            {
              echo ''
              echo "<script>"
              echo "const resultJson = "
              echo "</script>"
              echo "<script>"
              echo "const createdAt = $(date +%s);"
              echo "init();"
              echo "</script>"
              echo "</body>"
              echo "</html>"
            } >>"$reportName"

            echo "$reportName has been created!"
      - name: Creating Scan Details
        run: |
           scan_index='main/scan-results/scan_index.json'
           cat 
           {
              echo ','
              echo '{'
              echo '${{ github.ref }}'
              echo '${{ github.sha }}'
              echo '${{ github.triggering_actor }}'
              echo '${{ github.event.sha }}'
              echo '${{ github.event.event_path }}'
              echo "const createdAt = $(date +%s);"
              echo '}'
            }  >>"$scan_index"

            echo "$scan_index has been created!"
            
      - name: Checkout gh ğŸ›ï¸
        uses: actions/checkout@v3
        with:
           ref: gh-pages
           path: gh-pages
      - run: |
          audit_file='gh-pages/index.json'
          if [ -f $audit_file ]; then
              echo "$audit_file doesn't exist!"
           fi
      - name: Adding Scan Details to Audit db
        run: |
           audit_file='gh-pages/index.json'
           scan_index='main/scan-results/scan_index.json'
           if [ -f $audit_file ]; then
              echo "$audit_file doesn't exist!"
           fi
         
           index='main/scan-results/index.json'
           cat "$audit_file" >>"$index"
           cat "$scan_index" >>"$index"
           echo "$index has been created!"
           rm -f $scan_index
        
      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: scan-results # The folder the action should deploy.
