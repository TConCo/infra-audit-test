name: Deploy-scan-results-to-GitHub-pages

on:
  push:
    branches:
      - main
permissions:
  contents: write
env:
  scan_index: 'scan-results/scan_index.json'
  audit_file: 'gh-pages/index.json'
  index: 'scan-results/index.json'
  
jobs:
  build-and-deploy:
    concurrency: ci-${{ github.ref }} # Recommended if you intend to make multiple deployments in quick succession.
    runs-on: ubuntu-latest
    steps:
      - name: Set the time
        run: |
          echo "ACTION_START_TIME=$(date +%s)" >> $GITHUB_OUTPUT
          SCAN_RESULT='scan-results/result-${{steps.run_tests.outputs.ACTION_START_TIME}}.json'
          echo "SCAN_RESULT=$SCAN_RESULT" >> $GITHUB_OUTPUT
          EVENT_DETAIL='events/event-${{steps.run_tests.outputs.ACTION_START_TIME}}.json'
          echo "EVENT_DETAIL=$EVENT_DETAIL" >> $GITHUB_OUTPUT
        id: run_tests
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v3
      - name: Run Trivy vulnerability scanner in fs mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          hide-progress: false
          format: 'json'
          output: 'results.json'
      - name: Storing scan results
        run: |          
          cat "results.json" >>"${{steps.run_tests.outputs.SCAN_RESULT}}"
          echo "${{steps.run_tests.outputs.SCAN_RESULT}} has been created!"
      - name: Storing push event details
        id: store_event_details
        run: |
           cat ${{ github.event_path }}>>""${{steps.run_tests.outputs.EVENT_DETAIL}}"    
           echo "${{steps.run_tests.outputs.EVENT_DETAIL}} has been created!"
      - name: Creating Scan Details
        run: |
           cat 
           {
              echo '{'
              echo '"Id": "${{steps.run_tests.outputs.ACTION_START_TIME}}",'
              echo '"Url": "${{steps.run_tests.outputs.SCAN_RESULT}}",'
              echo '"Sha": "${{ github.sha }}",'
              echo '"Initiator": "${{ github.triggering_actor }}",'
              echo '"Ref": "${{ github.ref }}",'
              echo '"Event_Name": "${{ github.event_name }}",'
              echo '"Event_Path": "${{ steps.store_event_details.outputs.EVENT_DETAIL }}"'
              echo '},'
            }  >>"$scan_index"

            echo "$scan_index has been created!"            
      - name: Checkout gh ðŸ›Žï¸
        uses: actions/checkout@v3
        with:
           ref: gh-pages
           path: gh-pages
      - name: Adding Scan Details to Audit db
        run: |         
           if [ ! -f $audit_file ]; then
              echo "$audit_file doesn't exist, creating an empty one!"
              cat 
               {
                echo '{'
                echo '"Pushes" : ['
                echo ']}'
                
              }  >>"$audit_file"
           fi
           # copy audit file except the last line which is '}' character of json 
           head -n -1 "$audit_file" > "$index"
           cat "$scan_index" >>"$index"
           cat 
           {
              echo ''
              echo ']}'
            } >>"$index"
           echo "$index has been created!"
           # remove tmp
           rm -f $scan_index
        
      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: scan-results
          clean: false
