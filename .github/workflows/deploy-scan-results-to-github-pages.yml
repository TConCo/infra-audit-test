name: Deploy-scan-results-to-GitHub-pages

on:
  push:
    branches:
      - main
permissions:
  contents: write
env:
  scan_index: 'scan-results/scan_index.json'
  audit_file: 'gh-pages/index.json'
  index: 'scan-results/index.json'
  
jobs:
  build-and-deploy:
    concurrency: ci-${{ github.ref }} # Recommended if you intend to make multiple deployments in quick succession.
    runs-on: ubuntu-latest
    steps:
      - name: Set the time
        run: |
          echo "ACTION_START_TIME=$(date +%s)" >> $GITHUB_OUTPUT
        id: run_tests
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3
      - name: Creating scan results
        run: |
          reportName='scan-results/result-${{steps.run_tests.outputs.ACTION_START_TIME}}.json'
           cat 
            {
              echo ''
              echo "<script>"
              echo "const resultJson = "
              echo "</script>"
              echo "<script>"
              echo "const createdAt = ${{steps.run_tests.outputs.ACTION_START_TIME}};"
              echo "init();"
              echo "</script>"
              echo "</body>"
              echo "</html>"
            } >>"$reportName"

            echo "$reportName has been created!"
      - name: Creating Scan Details
        run: |
           cat 
           {
              echo '{'
              echo '"Id": "${{steps.run_tests.outputs.ACTION_START_TIME}}"'
              echo '"Sha": "${{ github.sha }}"'
              echo '"Initiator": "${{ github.triggering_actor }}"'
              echo '"Ref": "${{ github.ref }}"'
              echo '"Event_Name": "${{ github.event_name }}"'
              echo '"Event_Path": "${{ github.event_path }}"'
              echo '},'
            }  >>"$scan_index"

            echo "$scan_index has been created!"

      - name: Storing push event details
        run: |
           event_detail='scan-results/event-${{steps.run_tests.outputs.ACTION_START_TIME}}.json'
           cat ${{ github.event_path }}>>"$event_detail" 
           echo "$scan_index has been created!"
            
      - name: Checkout gh üõéÔ∏è
        uses: actions/checkout@v3
        with:
           ref: gh-pages
           path: gh-pages
      - name: Adding Scan Details to Audit db
        run: |         
           if [ ! -f $audit_file ]; then
              echo "$audit_file doesn't exist, creating an empty one!"
              cat 
               {
                echo '{'
                echo '"Pushes" : ['
                echo ']}'
                
              }  >>"$audit_file"
           fi
           # copy audit file except the last line which is '}' character of json 
           head -n -1 "$audit_file" > "$index"
           cat "$scan_index" >>"$index"
           cat 
           {
              echo ''
              echo ']}'
            } >>"$index"
           echo "$index has been created!"
           # remove tmp
           rm -f $scan_index
        
      - name: Deploy üöÄ
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: scan-results
          clean: false
