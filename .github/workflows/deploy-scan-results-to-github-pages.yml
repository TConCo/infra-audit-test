name: Deploy-scan-results-to-GitHub-pages

on:
  push:
    branches:
      - main
permissions:
  contents: write
  
env:
  DAY_OF_WEEK: $(date +%Y%m%d%H%M%S)
  
jobs:
  build-and-deploy:
    concurrency: ci-${{ github.ref }} # Recommended if you intend to make multiple deployments in quick succession.
    runs-on: ubuntu-latest
    env:
      Greeting: $(date +%s)
    steps:
      - name: Set the time
        run: |
          echo "ACTION_START_TIME=$(date +%s)" >> $GITHUB_OUTPUT
        id: run_tests
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3
      - name: Creating scan results
        run: |
          reportName='scan-results/result-${{steps.run_tests.outputs.ACTION_START_TIME}}.json'
           cat 
            {
              echo ''
              echo "<script>"
              echo "const resultJson = "
              echo "</script>"
              echo "<script>"
              echo "const createdAt = $(date +%s);"
              echo "init();"
              echo "</script>"
              echo "</body>"
              echo "</html>"
            } >>"$reportName"

            echo "$reportName has been created!"
      - name: Creating Scan Details
        run: |
           scan_index='scan-results/scan_index.json'
           echo "DAY_OF_WEEK: $DAY_OF_WEEK"
           echo "Greeting: $Greeting"
           cat 
           {
              echo '{'
              echo '"Id": "$DAY_OF_WEEK"'
              echo '"Sha": "${{ github.sha }}"'
              echo '"Initiator": "${{ github.triggering_actor }}"'
              echo '"Ref": "${{ github.ref }}"'
              echo '"Event_Name": "${{ github.event_name }}"'
              echo '"Event_Path": "${{ github.event_path }}"'
              echo '},'
            }  >>"$scan_index"

            echo "$scan_index has been created!"
            
      - name: Checkout gh ğŸ›ï¸
        uses: actions/checkout@v3
        with:
           ref: gh-pages
           path: gh-pages
      - name: Adding Scan Details to Audit db
        run: |
           audit_file='gh-pages/index.json'
           scan_index='scan-results/scan_index.json'
            
           if [ ! -f $audit_file ]; then
              echo "$audit_file doesn't exist, creating an empty one!"
              cat 
               {
                echo '{'
                echo '"Pushes" : ['
                echo ']}'
                
              }  >>"$audit_file"
           fi
         
           index='scan-results/index.json'
           head -n -1 "$audit_file" > "$index"
           #cat "$audit_file" >>"$index"
           cat "$scan_index" >>"$index"
           cat 
           {
              echo ''
              echo ']}'
            } >>"$index"
           echo "$index has been created!"
           rm -f $scan_index
        
      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: scan-results
